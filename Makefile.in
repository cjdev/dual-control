MODULEFLAGS = -fPIC -fno-stack-protector
MODULEOBJS = dual_control.o
MODULELIB = pam_dual_control.so


.PHONY: all
all: test dual_control.a

dual_control.a: $(MODULEOBJS)
	ar rvs $@ $^
	ranlib $@

$(MODULEOBJS): %.o: %.c
	$(CC) -c $(CFLAGS) $(CPPFLAGS) $(MODULEFLAGS) $< -o $@

.PHONY: clean
clean:
	@rm -f *.o *.a
	@rm -f dual_control_test

.PHONY: distclean
distclean: clean
	@rm -f Makefile config.h

dual_control_test: dual_control_test.c $(MODULEOBJS)
	$(CC) $(CFLAGS) $(CPPFLAGS) -o $@ $^

.PHONY: test
test: dual_control_test
	@./dual_control_test > /dev/null

.PHONY: install
install: $(MODULEOBJS)
	ld -x --shared -o @PAM_MODULE_DIRECTORY@/$(MODULELIB) $(MODULEOBJS)


