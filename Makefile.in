CXXFLAGS += -fPIC -fno-stack-protector -std=c++11
CFLAGS += -fPIC -fno-stack-protector
LDFLAGS = -lpam

INTEGRATION_OBJS = sys_syslog.o sys_fstream.o sys_unistd.o sys_pwd.o sys_pam.o dual_control_integrate.o
OBJS = dual_control.o request.o validator.o conversation.o user.o token.o logger.o session.o installer.o
TEST_SOURCES := $(wildcard *_test.cc)
TESTS := $(patsubst %.cc,%.out,$(TEST_SOURCES))
TESTRUNS := $(patsubst %.out,RUN_%,$(TESTS))

MODULELIB = pam_dual_control.so

UNAME_S := $(shell uname -s)

.PHONY: all
all: .depend dual_control.a dual_control

.PHONY: version
version:
	@echo COMPILER VERSION --------------------------------
	$(CXX) --version

dual_control.a: $(OBJS) $(INTEGRATION_OBJS)
	ar rvs $@ $^
	ranlib $@

dual_control: dual_control_tool.cc
	$(CXX) $(CXXFLAGS) $(CPPFLAGS)  -o $@ $^


.PHONY: clean
clean:
	@rm -f *.o *.a
	@rm -f *.out
	@rm ./.depend

.PHONY: distclean
distclean: clean
	@git clean -xdf

.depend: $(OBJS:.o=.cc) $(TEST_SOURCES)
	rm -f ./.depend
	$(CXX) -MM $^ > ./.depend;

-include .depend

%_test.out: %_test.o $(OBJS)
	$(CXX) $(CXXFLAGS) $(CPPFLAGS)  -o $@ $^

RUN_%: %.out
	@echo running $<
	@./$<

.PHONY: test
test: $(TESTRUNS)
	@echo Tests Passing

.PHONY: install
install: $(OBJS) $(INTEGRATION_OBJS)
ifeq ($(UNAME_S), Linux)
	$(CXX) -lpam -shared -Wl,-x -o $(DESTDIR)@PAM_MODULE_DIRECTORY@/$(MODULELIB) $(OBJS) $(INTEGRATION_OBJS)
else
	@echo installation recipe not known for $(UNAME_S)
endif

.PHONY: format
format:
	@./format.sh *.cc *.h


