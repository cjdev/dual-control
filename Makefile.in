CXXFLAGS += -fPIC -fno-stack-protector
CFLAGS += -fPIC -fno-stack-protector

OBJS = dual_control.o

MODULELIB = pam_dual_control.so

UNAME_S := $(shell uname -s)


.PHONY: all
all: dual_control.a

dual_control.a: $(OBJS)
	ar rvs $@ $^
	ranlib $@

.PHONY: clean
clean:
	@rm -f *.o *.a
	@rm -f dual_control_test

.PHONY: distclean
distclean: clean
	@rm -f Makefile config.h

dual_control.o: dual_control.h

argument_test: argument_test.o argument.o
	$(CXX) $(CXXFLAGS) $(CPPFLAGS)  -o $@ $^

validator_test: validator_test.o validator.o
	$(CXX) $(CXXFLAGS) $(CPPFLAGS)  -o $@ $^

conversation_test: conversation_test.o conversation.o
	$(CXX) $(CXXFLAGS) $(CPPFLAGS)  -o $@ $^

.PHONY: test
test: validator_test conversation_test argument_test
	@./validator_test
	@./conversation_test
	@./argument_test

.PHONY: install
install: $(OBJS)
ifeq ($(UNAME_S), Linux)
	ld $(LDFLAGS) -x --shared -lpam -o $(DESTDIR)@PAM_MODULE_DIRECTORY@/$(MODULELIB) $(OBJS)
else
	@echo installation recipe not known for $(UNAME_S)
endif

